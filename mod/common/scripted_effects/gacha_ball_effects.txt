create_gacha_ball = {
    create_struct = {
        struct_type = gacha_struct_ball
        struct_scope = $scope$
    }
    get_gacha_type = {
        scope = temporary_gacha_type
        type = $type$
    }
    scope:$scope$ = {
        set_variable = {
            name = gacha_type
            value = scope:temporary_gacha_type
        }
        set_variable = {
            name = gacha_rarity
            value = $rarity$
        }

    }
}

get_gacha_type = {
    every_in_global_list = {
        variable = gacha_types
        limit = {
            var:gacha_type_id ?= $type$
        }
        save_scope_as = $scope$
    }
}

create_gacha_types = {
    create_gacha_type = {
        type = gacha_type_environment
        name = gacha_ball_modifier_environment
    }
    create_gacha_type = {
        type = gacha_type_industry
        name = gacha_ball_modifier_industry
    }
}

create_gacha_type = {
    c:GBR = {
        if = {
            limit = {
                NOT = {
                    any_in_global_list = {
                        variable = gacha_types
                        var:gacha_type_id ?= $type$
                    }
                }
            }
            create_struct = {
                struct_type = gacha_struct_type
                struct_scope = temporary_gacha_type
            }
            scope:temporary_gacha_type = {
                set_variable = {
                    name = gacha_type_id
                    value = $type$
                }
                set_variable = {
                    name = gacha_type_name
                    value = flag:$name$
                }
                fix_variable_error = { variable = $name$ }
            }
            add_to_global_variable_list = {
                name = gacha_types
                target = scope:temporary_gacha_type
            }
        }
    }
}

apply_gacha_ball = {
    switch = {
        trigger = $ball$.var:gacha_type.var:gacha_type_id
        gacha_type_industry = {
            add_modifier = {
                name = gacha_ball_modifier_industry
                multiplier = $ball$.var:gacha_rarity
            }
        }
        gacha_type_environment = {
            add_modifier = {
                name = gacha_ball_modifier_environment
                multiplier = $ball$.var:gacha_rarity
            }
        }
    }
}

activate_gacha_ball = {
    # Remove existing boon in slot
    if = {
        limit = {
            var:$slot$ ?= var:gacha_selected
        }
        unapply_gacha_ball = {
            ball = var:$slot$
        }
        remove_variable = $slot$
    }
    else = {
        # Remove existing boon in slot
        if = {
            limit = {
                exists = var:$slot$
            }
            unapply_gacha_ball = {
                ball = var:$slot$
            }
            remove_variable = $slot$
        }

        # Remove selected boon from other slots
        remove_conflicting_gacha_ball = {
            slot = gacha_active_one
            boon = var:gacha_selected
        }
        remove_conflicting_gacha_ball = {
            slot = gacha_active_two
            boon = var:gacha_selected
        }
        remove_conflicting_gacha_ball = {
            slot = gacha_active_three
            boon = var:gacha_selected
        }

        # Activate selected boon
        set_variable = {
            name = $slot$
            value = var:gacha_selected
        }
        apply_gacha_ball = {
            ball = var:$slot$
        }
    }
}

remove_conflicting_gacha_ball = {
    if = {
        limit = {
            OR = {
                var:$slot$ ?= $boon$
                trigger_if = {
                    limit = {
                        exists = var:$slot$
                    }
                    var:$slot$.var:gacha_type = $boon$.var:gacha_type
                }
            }
        }
        unapply_gacha_ball = {
            ball = var:$slot$
        }
        remove_variable = $slot$
    }
}

unapply_gacha_ball = {
    switch = {
        trigger = $ball$.var:gacha_type.var:gacha_type_id
        gacha_type_industry = {
            remove_modifier = gacha_ball_modifier_industry
        }
        gacha_type_environment = {
            remove_modifier = gacha_ball_modifier_environment
        }
    }
}

pull_gacha = {
    create_gacha_ball = {
        scope = $scope$
        type = gacha_random_type
        rarity = gacha_random_rarity
    }
}

increase_gacha_rarity = {
    if = {
        limit = {
            $gacha$.var:gacha_rarity = gacha_rarity_common
        }
        remove_list_variable = {
            name = gacha_library_common
            target = $gacha$
        }
        add_to_variable_list = {
            name = gacha_library_uncommon
            target = $gacha$
        }
        $gacha$ = {
            set_variable = {
                name = gacha_rarity
                value = gacha_rarity_uncommon
            }
        }
    }
    else_if = {
        limit = {
            $gacha$.var:gacha_rarity = gacha_rarity_uncommon
        }
        remove_list_variable = {
            name = gacha_library_uncommon
            target = $gacha$
        }
        add_to_variable_list = {
            name = gacha_library_rare
            target = $gacha$
        }
        $gacha$ = {
            set_variable = {
                name = gacha_rarity
                value = gacha_rarity_rare
            }
        }
    }
    else_if = {
        limit = {
            $gacha$.var:gacha_rarity = gacha_rarity_rare
        }
        remove_list_variable = {
            name = gacha_library_rare
            target = $gacha$
        }
        add_to_variable_list = {
            name = gacha_library_epic
            target = $gacha$
        }
        $gacha$ = {
            set_variable = {
                name = gacha_rarity
                value = gacha_rarity_epic
            }
        }
    }
    else_if = {
        limit = {
            $gacha$.var:gacha_rarity = gacha_rarity_epic
        }
        remove_list_variable = {
            name = gacha_library_epic
            target = $gacha$
        }
        add_to_variable_list = {
            name = gacha_library_legendary
            target = $gacha$
        }
        $gacha$ = {
            set_variable = {
                name = gacha_rarity
                value = gacha_rarity_legendary
            }
        }
    }
}

add_pull_cost = {
    if = {
        limit = {
            NOT = {
                exists = var:gacha_free_pulls
            }
        }
        set_variable = {
            name = gacha_free_pulls
            value = 0
        }
    }

    if = {
        limit = {
            var:gacha_free_pulls > 0
        }
        change_variable = {
            name = gacha_free_pulls
            subtract = 1
        }
    }
    else = {
        add_modifier = {
            name = gacha_ball_pull_cost
            multiplier = money_amount_multiplier_small
        }
    }
}

add_gacha_free_pulls = {
    if = {
        limit = {
            NOT = {
                exists = var:gacha_free_pulls
            }
        }
        set_variable = {
            name = gacha_free_pulls
            value = 0
        }
    }
    change_variable = {
        name = gacha_free_pulls
        add = $amount$
    }
}